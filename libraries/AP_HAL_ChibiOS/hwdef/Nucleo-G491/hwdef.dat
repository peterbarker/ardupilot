# hw definition file for processing by chibios_pins.py
# MCU class and specific type

AUTOBUILD_TARGETS None

# MCU class and specific type
MCU STM32G4xx STM32G491xx

FLASH_RESERVE_START_KB 36

STORAGE_FLASH_PAGE 16
define HAL_STORAGE_SIZE 800

# board ID for firmware load
APJ_BOARD_ID 1040

# setup build for a peripheral firmware
env AP_PERIPH 1

# crystal frequency
OSCILLATOR_HZ 16000000

define CH_CFG_ST_FREQUENCY 1000000

FLASH_SIZE_KB 512

# LEDs
PA2 LED_RED OUTPUT HIGH GPIO(0)

# SWD debugging
PA13 JTMS-SWDIO SWD
PA14 JTCK-SWCLK SWD

# ADC inputs
define HAL_USE_ADC TRUE
define STM32_ADC_USE_ADC1 TRUE
define STM32_ADC_USE_ADC2 TRUE

# PA0 KILL1 ADC1 SCALE(1)
PA1 VBATT2    ADC1 SCALE(1)
PA3 13V3_SENS ADC1 SCALE(1)
PA4 13V4_SENS ADC2 SCALE(1)
PA5 CURR_SENS ADC2 SCALE(1)
PA6 13V2_SENS ADC2 SCALE(1)
PA7 13V1_SENS ADC2 SCALE(1)
PB0 VBATT1    ADC1 SCALE(1)
# PB3 KILL2 ADC1 SCALE(1)

define HAL_USE_SERIAL FALSE
define HAL_NO_UARTDRIVER TRUE

define HAL_NO_GPIO_IRQ

# avoid RCIN thread to save memory
define HAL_NO_RCIN_THREAD

define HAL_USE_RTC FALSE
define DISABLE_SERIAL_ESC_COMM TRUE

define DMA_RESERVE_SIZE 0

define HAL_DISABLE_LOOP_DELAY

# enable CAN support
PB5 CAN2_RX CAN2
PB6 CAN2_TX CAN2
PB7 GPIO_CAN2_SILENT OUTPUT PUSHPULL SPEED_LOW LOW

CAN_ORDER 2

define CAN_APP_NODE_NAME "rDS-24S"

define HAL_NO_LOGGING
define HAL_NO_MONITOR_THREAD

define HAL_DEVICE_THREAD_STACK 768

# we setup a small defaults.parm
# define AP_PARAM_MAX_EMBEDDED_PARAM 256

# keep ROMFS uncompressed as we don't have enough RAM
# to uncompress the bootloader at runtime
# env ROMFS_UNCOMPRESSED True

define HAL_PERIPH_ENABLE_BATTERY 1
define AP_BATT_MONITOR_MAX_INSTANCES 2

define HAL_BATT_MONITOR_DEFAULT 4
define HAL_BATT_VOLT_PIN 15
define HAL_BATT_CURR_PIN 13
define HAL_BATT2_VOLT_PIN 2
define HAL_BATT2_CURR_PIN 13

define HAL_BATT_VOLT_SCALE 33.33
define HAL_BATT_CURR_SCALE 40.0
define HAL_BATT2_VOLT_SCALE 33.33
define HAL_BATT2_CURR_SCALE 40.0
